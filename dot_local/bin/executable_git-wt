#!/usr/bin/env python3
"""Create a git worktree in ../ with slashes replaced by dashes.

Examples (in repo 'guided-selling'):
  git-wt main                    # ../guided-selling-main
  git-wt feat/login              # ../guided-selling-feat-login
  git-wt feat/login -d mydir     # ../guided-selling-mydir
  git-wt feat/new -b main        # ../guided-selling-feat-new
"""

import subprocess
import sys

from j_lib import JParser

parser = JParser(description="Create git worktree with slug name")
parser.add_argument("branch", help="Branch name for the worktree")
parser.add_argument(
    "-d", "--directory", metavar="DIR",
    help="Custom directory suffix (default: branch name)",
)
parser.add_argument(
    "-b", "--base", metavar="BRANCH",
    help="Create new branch from this base branch",
)
args = parser.run()

# Get repo root name
result = subprocess.run(
    ["git", "rev-parse", "--show-toplevel"],
    capture_output=True, text=True,
)
if result.returncode != 0:
    print("Not in a git repository", file=sys.stderr)
    sys.exit(1)

repo = result.stdout.strip().rsplit("/", 1)[-1]
suffix = (args.directory or args.branch).replace("/", "-")
dirname = f"../{repo}-{suffix}"

if args.base:
    cmd = ["git", "worktree", "add", "-b", args.branch, dirname, args.base]
else:
    cmd = ["git", "worktree", "add", dirname, args.branch]

result = subprocess.run(cmd)
if result.returncode == 0:
    print(f"\ncd {dirname}")
